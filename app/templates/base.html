<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spacegom Companion</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'orbitron': ['"Orbitron"', 'sans-serif'],
                        'tech': ['"Share Tech Mono"', 'monospace'],
                    },
                    colors: {
                        space: {
                            900: '#0b0d17',
                            800: '#15192b',
                            700: '#1f2640',
                        },
                        neon: {
                            blue: '#00f3ff',
                            green: '#00ff9d',
                            red: '#ff2a6d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .glass-panel {
            background: rgba(11, 13, 23, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }

        .tech-border {
            position: relative;
        }

        .tech-border::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 10px;
            height: 10px;
            border-top: 2px solid #00f3ff;
            border-left: 2px solid #00f3ff;
        }

        .tech-border::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            border-bottom: 2px solid #00f3ff;
            border-right: 2px solid #00f3ff;
        }

        /* Notification System */
        #toast-container {
            position: fixed;
            top: 100px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            min-width: 300px;
            padding: 16px 20px;
            background: rgba(21, 25, 43, 0.95);
            border-left: 4px solid;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.success {
            border-color: #00ff9d;
        }

        .toast.error {
            border-color: #ff2a6d;
        }

        .toast.info {
            border-color: #00f3ff;
        }

        .toast.warning {
            border-color: #ffa500;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        #results-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 450px;
            background: rgba(11, 13, 23, 0.98);
            border-left: 2px solid #00f3ff;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
            overflow-y: auto;
        }

        #results-panel.open {
            transform: translateX(0);
        }
    </style>
</head>

<body class="text-gray-300 font-tech min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 border-b border-gray-800 pb-4 flex justify-between items-end">
            <div>
                <h1
                    class="text-4xl font-orbitron font-bold text-neon-blue tracking-wider uppercase drop-shadow-[0_0_10px_rgba(0,243,255,0.5)]">
                    Spacegom <span class="text-white text-xl align-top opacity-80">Companion</span>
                </h1>
                <p class="text-neon-green text-sm tracking-widest mt-1">SYSTEM ONLINE // CAPTAIN ACCESS GRANTED</p>
            </div>
            <div class="text-right hidden md:block">
                <div class="text-xs text-gray-500 uppercase tracking-widest">Fecha del Juego</div>
                <div id="header-game-date" class="text-neon-blue font-orbitron">--</div>
            </div>
        </header>

        <!-- Global Navigation Bar -->
        <div id="global-nav" class="hidden mb-6">
            <!-- Navigation Tabs -->
            <div class="glass-panel rounded-t-lg border-b-0">
                <div class="flex flex-wrap gap-1 p-2">
                    <a href="#" id="nav-tab-dashboard" data-page="dashboard"
                        class="nav-tab px-4 py-2 rounded font-orbitron text-sm transition-all border-b-2 border-transparent hover:border-neon-blue hover:text-neon-blue">
                        üè† Dashboard
                    </a>
                    <a href="#" id="nav-tab-personnel" data-page="personnel"
                        class="nav-tab px-4 py-2 rounded font-orbitron text-sm transition-all border-b-2 border-transparent hover:border-neon-green hover:text-neon-green">
                        üë• Personal
                    </a>
                    <a href="#" id="nav-tab-treasury" data-page="treasury"
                        class="nav-tab px-4 py-2 rounded font-orbitron text-sm transition-all border-b-2 border-transparent hover:border-neon-blue hover:text-neon-blue">
                        üí∞ Tesorer√≠a
                    </a>
                    <a href="#" id="nav-tab-trade" data-page="trade"
                        class="nav-tab px-4 py-2 rounded font-orbitron text-sm transition-all border-b-2 border-transparent hover:border-orange-500 hover:text-orange-400">
                        ‚öñÔ∏è Comercio
                    </a>
                    <a href="#" id="nav-tab-missions" data-page="missions"
                        class="nav-tab px-4 py-2 rounded font-orbitron text-sm transition-all border-b-2 border-transparent hover:border-purple-500 hover:text-purple-400">
                        üìã Misiones
                    </a>
                    <a href="#" id="nav-tab-logs" data-page="logs"
                        class="nav-tab px-4 py-2 rounded font-orbitron text-sm transition-all border-b-2 border-transparent hover:border-yellow-500 hover:text-yellow-400">
                        üìú Logs
                    </a>
                </div>
            </div>

            <!-- Game Info Bar -->
            <div class="glass-panel rounded-b-lg border-t-0 p-3">
                <div class="flex flex-wrap items-center gap-4 text-xs">
                    <!-- Game Info -->
                    <div class="flex flex-wrap gap-3 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">üìÖ</span>
                            <span class="text-gray-400">Fecha:</span>
                            <span id="global-date" class="text-neon-blue font-orbitron">--</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">üåç</span>
                            <span class="text-gray-400">Planeta:</span>
                            <span id="global-planet" class="text-neon-green font-orbitron">--</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">üí∞</span>
                            <span class="text-gray-400">Saldo:</span>
                            <span id="global-treasury" class="text-neon-green font-orbitron">--</span>
                            <span class="text-gray-500">SC</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">üí∏</span>
                            <span class="text-gray-400">Gastos:</span>
                            <span id="global-expenses" class="text-neon-red font-orbitron">--</span>
                            <span class="text-gray-500">SC/mes</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">‚è±Ô∏è</span>
                            <span class="text-gray-400">Pr√≥x. Evento:</span>
                            <span id="global-next-event" class="text-purple-400 font-orbitron">--</span>
                        </div>
                    </div>

                    <!-- Advance Time Button -->
                    <button id="global-advance-time-btn" onclick="globalAdvanceTime()"
                        class="px-4 py-2 bg-neon-green bg-opacity-10 border-2 border-neon-green text-neon-green rounded font-orbitron text-sm hover:bg-opacity-20 transition-all flex items-center gap-2">
                        <span>‚ñ∂Ô∏è</span>
                        <span>Avanzar Tiempo</span>
                    </button>
                </div>
            </div>
        </div>

        <main>
            {% block content %}{% endblock %}
        </main>

        <footer class="mt-12 text-center text-xs text-gray-600 border-t border-gray-900 pt-4 font-mono">
            SPACEGOM COMPANION SYSTEM v0.1 // CONNECTION SECURE
        </footer>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container"></div>

    <!-- Results Panel -->
    <div id="results-panel">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-orbitron text-neon-blue">Resultados</h2>
                <button onclick="closeResultsPanel()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
            </div>
            <div id="results-content"></div>
        </div>
    </div>

    <!-- Global Notification System JS -->
    <!-- Sistema Universal de Dados -->
    <script src="/static/js/dice-roller.js"></script>

    <script>
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };

            toast.innerHTML = `
                <span class="text-2xl">${icons[type]}</span>
                <span class="text-sm text-white flex-1">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showResultsPanel(content) {
            document.getElementById('results-content').innerHTML = content;
            document.getElementById('results-panel').classList.add('open');
        }

        function closeResultsPanel() {
            document.getElementById('results-panel').classList.remove('open');
        }

        function showHireResult(data) {
            const diceHtml = data.dice.map(d =>
                `<span class="inline-block w-12 h-12 leading-12 text-center bg-white text-space-900 font-bold rounded text-xl">${d}</span>`
            ).join(' + ');

            const successClass = data.success ? 'text-neon-green' : 'text-neon-red';
            const successIcon = data.success ? '‚úÖ' : '‚ùå';
            const successText = data.success ? '√âXITO' : 'FRACASO';

            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="text-6xl mb-4">${successIcon}</div>
                        <div class="text-3xl font-orbitron ${successClass} mb-2">${successText}</div>
                        <div class="text-gray-400">${data.position}</div>
                        <div class="text-sm text-gray-500">${data.experience_level}</div>
                    </div>

                    <div class="glass-panel tech-border p-4 rounded">
                        <div class="text-xs text-gray-500 uppercase mb-3 tracking-wider">Tirada de Dados</div>
                        <div class="flex items-center justify-center gap-2 mb-4">
                            ${diceHtml}
                        </div>
                        <div class="text-center text-sm text-gray-400">
                            Suma: ${data.dice.reduce((a, b) => a + b, 0)}
                        </div>
                       <div class="text-xs text-gray-500 mt-2">
                            Modificadores: ${data.modifiers ? `Exp(${data.modifiers.experience >= 0 ? '+' : ''}${data.modifiers.experience}) + Moral(${data.modifiers.morale >= 0 ? '+' : ''}${data.modifiers.morale}) + Rep(${data.modifiers.reputation >= 0 ? '+' : ''}${data.modifiers.reputation}) = ${data.modifiers.total >= 0 ? '+' : ''}${data.modifiers.total}` : '0'}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass-panel p-4 rounded text-center">
                            <div class="text-xs text-gray-500 uppercase mb-1">Resultado Final</div>
                            <div class="text-2xl font-orbitron text-neon-blue">${data.total}</div>
                        </div>
                        <div class="glass-panel p-4 rounded text-center">
                            <div class="text-xs text-gray-500 uppercase mb-1">Umbral</div>
                            <div class="text-2xl font-orbitron text-gray-300">${data.threshold}</div>
                        </div>
                    </div>

                    ${data.success ? `
                        <div class="bg-neon-green bg-opacity-10 border border-neon-green rounded p-4">
                            <div class="text-neon-green font-orbitron mb-2">Empleado Contratado</div>
                            <div class="text-sm text-gray-300">ID: ${data.new_employee_id}</div>
                        </div>
                    ` : `
                        <div class="bg-neon-red bg-opacity-10 border border-neon-red rounded p-4">
                            <div class="text-neon-red font-orbitron">No se encontr√≥ candidato adecuado</div>
                        </div>
                    `}

                    ${data.next_task_started ? `
                        <div class="bg-purple-500 bg-opacity-10 border border-purple-500 rounded p-4">
                            <div class="text-purple-400 font-orbitron mb-2">‚è≠Ô∏è Siguiente B√∫squeda Iniciada</div>
                            <div class="text-sm text-gray-300">${data.next_task_started.position}</div>
                            <div class="text-xs text-gray-500">Finaliza: ${data.next_task_started.completion_date}</div>
                        </div>
                    ` : ''}
                </div>
            `;

            showResultsPanel(content);
        }

        // Global function to update header game date
        async function updateHeaderGameDate(gameId) {
            if (!gameId) {
                const urlParams = new URLSearchParams(window.location.search);
                gameId = urlParams.get('game_id');
            }

            if (!gameId) return;

            try {
                const response = await fetch(`/api/games/${gameId}`);
                const data = await response.json();
                const day = String(data.state.day || 1).padStart(2, '0');
                const month = String(data.state.month || 1).padStart(2, '0');
                const year = data.state.year || 1;

                const dateEl = document.getElementById('header-game-date');
                if (dateEl) {
                    dateEl.textContent = `${day}-${month}-${year}`;
                }
            } catch (error) {
                console.error('Error updating header date:', error);
            }
        }

        // Global Navigation Initialization
        async function initGlobalNav() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game_id');

            if (!gameId) {
                // No game ID, hide global nav
                return;
            }

            // Show global navigation
            document.getElementById('global-nav')?.classList.remove('hidden');

            // Update navigation links with game_id
            document.getElementById('nav-tab-dashboard').href = `/dashboard?game_id=${gameId}`;
            document.getElementById('nav-tab-personnel').href = `/personnel?game_id=${gameId}`;
            document.getElementById('nav-tab-treasury').href = `/treasury?game_id=${gameId}`;
            document.getElementById('nav-tab-trade').href = `/trade?game_id=${gameId}`;
            document.getElementById('nav-tab-missions').href = `/missions?game_id=${gameId}`;
            document.getElementById('nav-tab-logs').href = `/logs?game_id=${gameId}`;
            document.getElementById('nav-tab-logs').href = `/logs?game_id=${gameId}`;

            // Highlight active tab based on current page
            highlightActiveTab();

            // Load and display global game info
            await loadGlobalGameInfo(gameId);
        }

        function highlightActiveTab() {
            const currentPath = window.location.pathname;
            const tabs = document.querySelectorAll('.nav-tab');

            tabs.forEach(tab => {
                const page = tab.getAttribute('data-page');
                tab.classList.remove('border-neon-blue', 'border-neon-green', 'border-purple-500', 'border-yellow-500', 'text-white');

                if (currentPath.includes(page)) {
                    tab.classList.add('text-white');
                    // Add appropriate color based on page
                    if (page === 'dashboard') tab.classList.add('border-neon-blue');
                    else if (page === 'personnel') tab.classList.add('border-neon-green');
                    else if (page === 'treasury') tab.classList.add('border-neon-blue');
                    else if (page === 'trade') tab.classList.add('border-orange-500');
                    else if (page === 'missions') tab.classList.add('border-purple-500');
                    else if (page === 'logs') tab.classList.add('border-yellow-500');
                }
            });
        }

        async function loadGlobalGameInfo(gameId) {
            try {
                // Fetch game state
                const gameResponse = await fetch(`/api/games/${gameId}`);
                const gameData = await gameResponse.json();
                const state = gameData.state;

                // Fetch treasury info
                const treasuryResponse = await fetch(`/api/games/${gameId}/treasury`);
                const treasuryData = await treasuryResponse.json();

                // Update date
                const day = String(state.day || 1).padStart(2, '0');
                const month = String(state.month || 1).padStart(2, '0');
                const year = state.year || 1;
                document.getElementById('global-date').textContent = `${day}-${month}-${year}`;

                // Update planet with name and code
                const planetCode = state.current_planet_code || '???';
                let planetDisplay = planetCode;

                if (planetCode !== '???') {
                    try {
                        const planetResponse = await fetch(`/api/planets/${planetCode}`);
                        const planetData = await planetResponse.json();
                        planetDisplay = `${planetData.planet.name} (${planetCode})`;
                    } catch (e) {
                        console.warn('Could not fetch planet name:', e);
                        planetDisplay = planetCode;
                    }
                }

                document.getElementById('global-planet').textContent = planetDisplay;

                // Update treasury
                const balance = treasuryData.current_balance || 0;
                document.getElementById('global-treasury').textContent = balance;

                // Update expenses
                const expenses = treasuryData.monthly_expenses?.total || 0;
                document.getElementById('global-expenses').textContent = expenses;

                // Update next event
                const nextEvent = state.event_queue?.[0];
                document.getElementById('global-next-event').textContent = nextEvent?.date || '-';

            } catch (error) {
                console.error('Error loading global game info:', error);
            }
        }

        // Global Advance Time Function - with proper dice handling
        async function globalAdvanceTime() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game_id');

            if (!gameId) {
                showToast('No se encontr√≥ ID de juego', 'error');
                return;
            }

            // Show dice mode selection modal
            const modal = document.createElement('div');
            modal.id = 'global-dice-mode-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-panel tech-border p-8 rounded-lg max-w-md w-full">
                    <h3 class="text-2xl font-orbitron text-neon-blue mb-6">üé≤ Avanzar Tiempo</h3>
                    <p class="text-gray-400 mb-6">¬øC√≥mo deseas resolver la tirada (si es necesaria)?</p>
                    <div class="space-y-3">
                        <button onclick="globalProceedWithDice('auto')" 
                            class="w-full py-4 bg-neon-blue bg-opacity-20 border-2 border-neon-blue text-neon-blue rounded hover:bg-opacity-30 font-orbitron">
                            ü§ñ AUTOM√ÅTICA<div class="text-xs text-gray-400 mt-1">El sistema tira los dados si es necesario</div>
                        </button>
                        <button onclick="globalProceedWithDice('manual')" 
                            class="w-full py-4 bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green rounded hover:bg-opacity-30 font-orbitron">
                            üéØ MANUAL<div class="text-xs text-gray-400 mt-1">Introduces tus dados f√≠sicos</div>
                        </button>
                    </div>
                    <button onclick="document.getElementById('global-dice-mode-modal').remove()" 
                        class="w-full mt-4 py-2 bg-gray-700 border border-gray-600 text-gray-300 rounded hover:bg-gray-600">
                        Cancelar
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function globalProceedWithDice(mode) {
            document.getElementById('global-dice-mode-modal')?.remove();

            if (mode === 'manual') {
                globalShowManualDice();
            } else {
                globalExecuteTimeAdvance();
            }
        }

        function globalShowManualDice() {
            const modal = document.createElement('div');
            modal.id = 'global-manual-dice-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-panel tech-border p-8 rounded-lg max-w-md w-full">
                    <h3 class="text-2xl font-orbitron text-neon-blue mb-6">üé≤ Tira 2d6</h3>
                    <p class="text-gray-400 mb-4">Introduce los resultados:</p>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm text-gray-500 mb-2">Dado 1</label>
                            <input type="number" id="global-dice1" min="1" max="6" 
                                class="w-full bg-space-800 border border-gray-700 rounded px-4 py-3 text-white text-center text-2xl font-orbitron">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-2">Dado 2</label>
                            <input type="number" id="global-dice2" min="1" max="6" 
                                class="w-full bg-space-800 border border-gray-700 rounded px-4 py-3 text-white text-center text-2xl font-orbitron">
                        </div>
                    </div>
                    <button onclick="globalSubmitManualDice()" 
                        class="w-full py-3 bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green rounded hover:bg-opacity-30 font-orbitron mb-2">
                        Confirm
                    </button>
                    <button onclick="document.getElementById('global-manual-dice-modal').remove()" 
                        class="w-full py-2 bg-gray-700 border border-gray-600 text-gray-300 rounded hover:bg-gray-600">
                        Cancelar
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('global-dice1').focus();
        }

        async function globalSubmitManualDice() {
            const d1 = parseInt(document.getElementById('global-dice1').value);
            const d2 = parseInt(document.getElementById('global-dice2').value);

            if (!d1 || !d2 || d1 < 1 || d1 > 6 || d2 < 1 || d2 > 6) {
                showToast('Valores inv√°lidos (1-6)', 'warning');
                return;
            }

            document.getElementById('global-manual-dice-modal')?.remove();
            globalExecuteTimeAdvance([d1, d2]);
        }

        async function globalExecuteTimeAdvance(manualDice = null) {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game_id');

            try {
                const formData = new FormData();
                if (manualDice) {
                    formData.append('manual_dice', manualDice.join(','));
                }

                const response = await fetch(`/api/games/${gameId}/time/advance`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'no_events') {
                    showToast('No hay eventos pendientes', 'info');
                    return;
                }

                if (response.ok && data.event_result) {
                    const result = data.event_result;

                    showToast(`‚è∞ Avanzado: ${data.old_date} ‚Üí ${data.new_date}`, 'info');

                    // Handle different event types
                    if (result.type === 'hire_resolution') {
                        // Show hire result if showHireResult function exists
                        if (typeof window.showHireResult === 'function') {
                            window.showHireResult(result);
                        }
                    } else if (result.type === 'salary_payment') {
                        // Show salary payment modal
                        showSalaryPaymentModal(result);
                    } else if (result.type === 'mission_deadline' && result.requires_user_input) {
                        // Show mission deadline modal - don't refresh yet
                        showMissionDeadlineModal(result, gameId);
                        return; // Exit early, will refresh after user resolves mission
                    }

                    // Refresh global nav info
                    await loadGlobalGameInfo(gameId);

                    // Refresh header date  
                    await updateHeaderGameDate(gameId);

                    // Reload current page data if functions exist
                    if (typeof window.loadDirectorTasks === 'function') {
                        await window.loadDirectorTasks();
                    }
                    if (typeof window.loadPersonnel === 'function') {
                        await window.loadPersonnel();
                    }
                    if (typeof window.loadGameDate === 'function') {
                        await window.loadGameDate();
                    }
                    if (typeof window.loadLogs === 'function') {
                        await window.loadLogs();
                    }
                } else {
                    showToast('Error: ' + (data.detail || 'Error desconocido'), 'error');
                }
            } catch (error) {
                console.error('Error advancing time:', error);
                showToast('Error avanzando el tiempo', 'error');
            }
        }

        // ========== SALARY PAYMENT MODAL ==========
        function showSalaryPaymentModal(result) {
            const modal = document.createElement('div');
            modal.id = 'salary-payment-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-panel tech-border p-8 rounded-lg max-w-md w-full">
                    <h3 class="text-2xl font-orbitron text-yellow-400 mb-6">üí∏ Pago de Salarios</h3>
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Empleados:</span>
                            <span class="text-white font-bold">${result.employees_count}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Total pagado:</span>
                            <span class="text-neon-red font-bold">${result.total_paid} SC</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Saldo anterior:</span>
                            <span class="text-gray-300">${result.old_balance} SC</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-400">Saldo actual:</span>
                            <span class="text-neon-green font-bold text-xl">${result.new_balance} SC</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('salary-payment-modal').remove()" 
                        class="w-full py-3 bg-neon-blue bg-opacity-20 border-2 border-neon-blue text-neon-blue rounded hover:bg-opacity-30 font-orbitron">
                        Aceptar
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ========== MISSION DEADLINE MODAL ==========
        function showMissionDeadlineModal(missionData, gameId) {
            const modal = document.createElement('div');
            modal.id = 'mission-deadline-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-panel tech-border p-8 rounded-lg max-w-md w-full">
                    <h3 class="text-2xl font-orbitron text-yellow-400 mb-6">‚è∞ Fecha L√≠mite de Misi√≥n</h3>
                    <div class="mb-6">
                        <p class="text-neon-blue font-orbitron mb-2 text-lg">${missionData.objective}</p>
                        <p class="text-gray-400 text-sm mb-2">üìç ${missionData.execution_place}</p>
                        ${missionData.notes ? `<p class="text-gray-500 text-sm italic">${missionData.notes}</p>` : ''}
                    </div>
                    <p class="text-gray-300 mb-6">¬øLa misi√≥n se complet√≥ con √©xito?</p>
                    <div class="space-y-3">
                        <button onclick="resolveMission(${missionData.mission_id}, true, '${gameId}')" 
                            class="w-full py-4 bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green rounded hover:bg-opacity-30 font-orbitron">
                            ‚úÖ MISI√ìN EXITOSA
                        </button>
                        <button onclick="resolveMission(${missionData.mission_id}, false, '${gameId}')" 
                            class="w-full py-4 bg-neon-red bg-opacity-20 border-2 border-neon-red text-neon-red rounded hover:bg-opacity-30 font-orbitron">
                            ‚ùå MISI√ìN FALLIDA
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ========== MISSION RESOLUTION ==========
        async function resolveMission(missionId, success, gameId) {
            document.getElementById('mission-deadline-modal')?.remove();

            const formData = new FormData();
            formData.append('success', success);

            try {
                const response = await fetch(`/api/games/${gameId}/missions/${missionId}/resolve`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`Misi√≥n resuelta: ${success ? '‚úÖ √âxito' : '‚ùå Fracaso'}`, success ? 'success' : 'warning');

                    // Refresh all game data
                    await loadGlobalGameInfo(gameId);
                    await updateHeaderGameDate(gameId);

                    // Refresh page-specific data if functions exist
                    if (typeof window.loadDirectorTasks === 'function') {
                        await window.loadDirectorTasks();
                    }
                    if (typeof window.loadLogs === 'function') {
                        await window.loadLogs();
                    }
                } else {
                    showToast('Error: ' + (data.detail || 'Error desconocido'), 'error');
                }
            } catch (error) {
                console.error('Error resolving mission:', error);
                showToast('Error resolviendo misi√≥n', 'error');
            }
        }

        // Auto-initialize global nav on page load
        document.addEventListener('DOMContentLoaded', () => {
            initGlobalNav();
        });
    </script>
</body>

</html>