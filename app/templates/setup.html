{% extends "base.html" %}
<!--
    Template de inicializaci√≥n de partida (setup wizard).
    
    Gu√≠a al jugador a trav√©s del proceso completo de setup paso a paso:
    1. Identificaci√≥n de Compa√±√≠a y Nave
    2. Determinaci√≥n de √Årea (2d6)
    3. Densidad de Mundos (2d6)
    4. Posici√≥n de la Nave (1d6 columna, 1d6 fila)
    5. Planeta Inicial (3d6 con validaci√≥n)
    6. Selecci√≥n de Dificultad
    
    Cada secci√≥n se desbloquea secuencialmente despu√©s de completar la anterior.
    Las tiradas de dados pueden ser autom√°ticas o manuales (dados f√≠sicos).
-->

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Banner de historia/lore: Contexto narrativo de la herencia -->
    <div class="glass-panel tech-border p-6 rounded-lg mb-6 border-l-4 border-neon-blue">
        <h2 class="text-2xl font-orbitron text-neon-blue mb-3">HERENCIA FAMILIAR</h2>
        <p class="text-gray-300 leading-relaxed mb-2">
            Tu madre ha fallecido, dej√°ndote como √∫nico heredero de su empresa espacial.
            Junto con la compa√±√≠a, heredas una nave, una tripulaci√≥n leal y algo de capital inicial.
        </p>
        <p class="text-neon-green text-sm font-tech">
            Es hora de establecer tu emplazamiento en el espacio y empezar tu legado...
        </p>
    </div>

    <!-- Formulario de setup con secciones secuenciales -->
    <div class="glass-panel tech-border p-8 rounded-lg">
        <h2 class="text-3xl font-orbitron text-white mb-6 border-b border-gray-700 pb-3">
            <span class="text-neon-blue">EMPLAZAMIENTO</span> INICIAL
        </h2>

        <div id="setup-form" class="space-y-6">
            <!-- Secci√≥n 1: Identificaci√≥n de Compa√±√≠a y Nave -->
            <div class="bg-space-800 border border-gray-700 rounded-lg p-5" id="company-section">
                <h3 class="text-lg font-orbitron text-neon-blue mb-3 flex items-center">
                    <span class="text-2xl mr-2">üè¢</span> IDENTIFICACI√ìN DE COMPA√ë√çA
                </h3>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase tracking-widest mb-1 block">Nombre de la
                            Compa√±√≠a</label>
                        <div class="flex gap-2">
                            <input type="text" id="company-name" placeholder="Ej: Starblack Corp"
                                class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech">
                            <button onclick="suggestCompanyName()"
                                class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 rounded text-gray-300">Sugerir</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 uppercase tracking-widest mb-1 block">Nombre de la
                            Nave</label>
                        <div class="flex gap-2">
                            <input type="text" id="ship-name" placeholder="Ej: F√©nix Dorado"
                                class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech">
                            <button onclick="suggestShipName()"
                                class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 rounded text-gray-300">Sugerir</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 uppercase tracking-widest mb-1 block">Modelo de Nave</label>
                        <select id="ship-model" disabled
                            class="w-full bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech opacity-70">
                            <option value="Basic Starfall" selected>Basic Starfall (1 Cuad, 40 UCN)</option>
                        </select>
                        <p class="text-[10px] text-gray-500 mt-2 italic">
                            üöÄ Para el inicio de la aventura (herencia), tu nave es fija al modelo <strong>Basic
                                Starfall</strong>.
                        </p>
                    </div>

                    <button onclick="saveCompanyDetails()" id="btn-save-company"
                        class="w-full bg-neon-blue bg-opacity-20 hover:bg-opacity-30 border-2 border-neon-blue text-neon-blue py-3 rounded font-tech uppercase transition-all">
                        Confirmar Identidad
                    </button>
                </div>
            </div>

            <!-- Secci√≥n 2: Determinaci√≥n de √Årea - Tirada 2d6 (rango 2-12) -->
            <div class="bg-space-800 border border-gray-700 rounded-lg p-5" id="area-section" style="display: none;">
                <h3 class="text-lg font-orbitron text-neon-blue mb-3 flex items-center">
                    <span class="text-2xl mr-2">üé≤</span> √ÅREA DEL ESPACIO
                </h3>
                <p class="text-sm text-gray-400 mb-4">Tira 2d6 para determinar el √°rea donde estableces tu empresa
                    (2-12)</p>

                <div class="flex gap-3 mb-3">
                    <button onclick="rollArea(false)"
                        class="flex-1 bg-neon-blue bg-opacity-20 hover:bg-opacity-30 border-2 border-neon-blue text-neon-blue px-4 py-3 rounded font-tech uppercase tracking-wider transition-all hover:shadow-[0_0_15px_rgba(0,243,255,0.4)]">
                        üé≤ Tirada Autom√°tica
                    </button>
                    <button onclick="showManualArea()"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 border-2 border-gray-600 text-gray-300 px-4 py-3 rounded font-tech uppercase tracking-wider transition-all">
                        ‚úçÔ∏è Introducir Manual
                    </button>
                </div>

                <div id="manual-area-input" class="hidden mb-3">
                    <div class="flex gap-2">
                        <input type="number" id="area-die1" min="1" max="6" placeholder="Dado 1"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <span class="text-gray-500 text-2xl">+</span>
                        <input type="number" id="area-die2" min="1" max="6" placeholder="Dado 2"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <button onclick="rollArea(true)"
                            class="bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green px-6 rounded hover:bg-opacity-30">
                            CONFIRMAR
                        </button>
                    </div>
                </div>

                <div id="area-result" class="hidden">
                    <div class="bg-neon-blue bg-opacity-10 border-2 border-neon-blue rounded p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs text-gray-400 uppercase mb-1">Dados</div>
                                <div class="text-white font-tech" id="area-dice">-</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-400 uppercase mb-1">√Årea Asignada</div>
                                <div class="text-5xl font-orbitron text-neon-blue font-bold" id="area-value">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- World Density Determination -->
            <div class="bg-space-800 border border-gray-700 rounded-lg p-5" id="density-section" style="display: none;">
                <h3 class="text-lg font-orbitron text-neon-green mb-3 flex items-center">
                    <span class="text-2xl mr-2">üåç</span> DENSIDAD DE MUNDOS
                </h3>
                <p class="text-sm text-gray-400 mb-4">Tira 2d6 para determinar la densidad de planetas en tu √°rea</p>

                <div class="flex gap-3 mb-3">
                    <button onclick="rollDensity(false)"
                        class="flex-1 bg-neon-green bg-opacity-20 hover:bg-opacity-30 border-2 border-neon-green text-neon-green px-4 py-3 rounded font-tech uppercase tracking-wider transition-all hover:shadow-[0_0_15px_rgba(0,255,157,0.4)]">
                        üé≤ Tirada Autom√°tica
                    </button>
                    <button onclick="showManualDensity()"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 border-2 border-gray-600 text-gray-300 px-4 py-3 rounded font-tech uppercase tracking-wider transition-all">
                        ‚úçÔ∏è Introducir Manual
                    </button>
                </div>

                <div id="manual-density-input" class="hidden mb-3">
                    <div class="flex gap-2">
                        <input type="number" id="density-die1" min="1" max="6" placeholder="Dado 1"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <span class="text-gray-500 text-2xl">+</span>
                        <input type="number" id="density-die2" min="1" max="6" placeholder="Dado 2"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <button onclick="rollDensity(true)"
                            class="bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green px-6 rounded hover:bg-opacity-30">
                            CONFIRMAR
                        </button>
                    </div>
                </div>

                <div id="density-result" class="hidden">
                    <div class="bg-neon-green bg-opacity-10 border-2 border-neon-green rounded p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs text-gray-400 uppercase mb-1">Dados</div>
                                <div class="text-white font-tech" id="density-dice">-</div>
                            </div>
                            <div class="text-center flex-1">
                                <div class="text-xs text-gray-400 uppercase mb-1">Total</div>
                                <div class="text-2xl font-orbitron text-white" id="density-total">-</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-400 uppercase mb-1">Densidad</div>
                                <div class="text-3xl font-orbitron text-neon-green font-bold" id="density-level">-</div>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-500 border-t border-gray-700 pt-3">
                            <strong>Baja:</strong> 2-4 | <strong>Media:</strong> 5-9 | <strong>Alta:</strong> 10-12
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ship Position Determination -->
            <div class="bg-space-800 border border-gray-700 rounded-lg p-5" id="position-section"
                style="display: none;">
                <h3 class="text-lg font-orbitron text-orange-400 mb-3 flex items-center">
                    <span class="text-2xl mr-2">üöÄ</span> POSICI√ìN INICIAL DE LA NAVE
                </h3>
                <p class="text-sm text-gray-400 mb-4">Tira 1d6 para la columna (A-F) y 1d6 para la fila (1-6)</p>

                <div class="flex gap-3 mb-3">
                    <button onclick="rollPosition(false)"
                        class="flex-1 bg-orange-500 bg-opacity-20 hover:bg-opacity-30 border-2 border-orange-500 text-orange-400 px-4 py-3 rounded font-tech uppercase tracking-wider transition-all hover:shadow-[0_0_15px_rgba(255,165,0,0.4)]">
                        üé≤ Tirada Autom√°tica
                    </button>
                    <button onclick="showManualPosition()"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 border-2 border-gray-600 text-gray-300 px-4 py-3 rounded font-tech uppercase tracking-wider transition-all">
                        ‚úçÔ∏è Introducir Manual
                    </button>
                </div>

                <div id="manual-position-input" class="hidden mb-3">
                    <div class="flex gap-2">
                        <input type="number" id="pos-col-die" min="1" max="6" placeholder="Col (1-6)"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <input type="number" id="pos-row-die" min="1" max="6" placeholder="Fila (1-6)"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <button onclick="rollPosition(true)"
                            class="bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green px-6 rounded hover:bg-opacity-30">
                            CONFIRMAR
                        </button>
                    </div>
                </div>

                <div id="position-result" class="hidden">
                    <div class="bg-orange-500 bg-opacity-10 border-2 border-orange-500 rounded p-4">
                        <div class="flex items-center justify-between">
                            <div class="text-center flex-1">
                                <div class="text-xs text-gray-400 uppercase mb-1">Columna</div>
                                <div class="text-3xl font-orbitron text-white" id="pos-col-val">-</div>
                            </div>
                            <div class="text-center flex-1">
                                <div class="text-xs text-gray-400 uppercase mb-1">Fila</div>
                                <div class="text-3xl font-orbitron text-white" id="pos-row-val">-</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-400 uppercase mb-1">Cuadrante</div>
                                <div class="text-4xl font-orbitron text-orange-400 font-bold" id="pos-quadrant">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Starting Planet Determination -->
            <div class="bg-space-800 border border-gray-700 rounded-lg p-5" id="planet-section" style="display: none;">
                <h3 class="text-lg font-orbitron text-neon-blue mb-3 flex items-center">
                    <span class="text-2xl mr-2">ü™ê</span> PLANETA DE ORIGEN
                </h3>
                <p class="text-sm text-gray-400 mb-4">Tira 3d6 uno tras otro para obtener el C√ìDIGO MUNDO (111-666)</p>

                <div class="flex gap-3 mb-3">
                    <button onclick="rollPlanet(false)"
                        class="flex-1 bg-neon-blue bg-opacity-20 hover:bg-opacity-30 border-2 border-neon-blue text-neon-blue px-4 py-3 rounded font-tech uppercase tracking-wider transition-all hover:shadow-[0_0_15px_rgba(0,243,255,0.4)]">
                        üé≤ Tirada Autom√°tica
                    </button>
                    <button onclick="showManualPlanet()"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 border-2 border-gray-600 text-gray-300 px-4 py-3 rounded font-tech uppercase tracking-wider transition-all">
                        ‚úçÔ∏è Introducir Manual
                    </button>
                </div>

                <div id="manual-planet-input" class="hidden mb-3">
                    <div class="flex gap-2">
                        <input type="number" id="planet-die1" min="1" max="6" placeholder="D1"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <input type="number" id="planet-die2" min="1" max="6" placeholder="D2"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <input type="number" id="planet-die3" min="1" max="6" placeholder="D3"
                            class="flex-1 bg-space-900 border border-gray-600 rounded px-3 py-2 text-white font-tech text-center">
                        <button onclick="rollPlanet(true)"
                            class="bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green px-6 rounded hover:bg-opacity-30">
                            BUSCAR
                        </button>
                    </div>
                </div>

                <!-- Planet Stats & Validation -->
                <div id="planet-result" class="hidden space-y-4">
                    <div id="planet-basic-info" class="bg-space-900 border border-gray-700 rounded p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-2xl font-orbitron text-white" id="res-planet-name">-</h4>
                                <div class="text-neon-blue font-tech" id="res-planet-code">#---</div>
                            </div>
                            <div id="val-badge" class="px-3 py-1 rounded text-xs font-tech uppercase">Cargando...</div>
                        </div>

                        <div id="missing-data-form"
                            class="mt-4 p-4 border border-orange-500 bg-orange-500 bg-opacity-10 rounded hidden">
                            <p class="text-orange-400 text-xs mb-3 font-bold">‚ö†Ô∏è FALTAN DATOS EN ARCHIVOS ESTELARES</p>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs text-gray-300">Nivel Tecnol√≥gico:</label>
                                    <select id="input-tech"
                                        class="bg-space-800 border border-gray-600 rounded text-xs px-2 py-1">
                                        <option value="">Seleccionar...</option>
                                        <option value="PR">PRIMITIVO</option>
                                        <option value="RUD">RUDIMENTARIO</option>
                                        <option value="ES">ESPACIAL</option>
                                        <option value="INT">INTERESTELAR</option>
                                        <option value="POL">POSINTERESTELAR</option>
                                        <option value="N.S">NIVEL SUPERIOR</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="text-xs text-gray-300">Poblaci√≥n > 1000:</label>
                                    <input type="checkbox" id="input-pop" class="rounded border-gray-600 bg-space-800">
                                </div>
                                <button onclick="updatePlanetData()"
                                    class="w-full py-2 bg-orange-500 text-white rounded text-xs font-bold hover:bg-orange-600">ACTUALIZAR
                                    BASE DE DATOS</button>
                            </div>
                        </div>

                        <div id="validation-checks"
                            class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 text-[10px] font-tech">
                            <div class="flex items-center gap-2">
                                <span id="check-pop" class="text-gray-500">‚óã</span>
                                <span class="text-gray-400">Poblaci√≥n > 1000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="check-tech" class="text-gray-500">‚óã</span>
                                <span class="text-gray-400">Tecnolog√≠a apta (No PR/RUD)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="check-support" class="text-gray-500">‚óã</span>
                                <span class="text-gray-400">Soporte Vital B√°sico</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="check-conv" class="text-gray-500">‚óã</span>
                                <span class="text-gray-400">Convenio Spacegom</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="check-prod" class="text-gray-500">‚óã</span>
                                <span class="text-gray-400">Tiene productos</span>
                            </div>
                        </div>
                    </div>

                    <div id="planet-action" class="hidden">
                        <button id="btn-select-planet" onclick="selectStartingPlanet()"
                            class="w-full py-4 bg-neon-green bg-opacity-20 border-2 border-neon-green text-neon-green rounded font-orbitron hover:bg-opacity-30">
                            ESTABLECER COMO ORIGEN
                        </button>
                    </div>

                    <!-- DIFFICULTY SELECTION (shown after planet is selected) -->
                    <div id="difficulty-section" class="hidden mt-6">
                        <div class="mb-4">
                            <h4 class="text-neon-blue font-orbitron text-lg mb-2">Selecciona Dificultad</h4>
                            <p class="text-gray-400 text-sm">El nivel de dificultad determina tu capital inicial</p>
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="completSetupWithDifficulty('easy')"
                                class="p-4 bg-space-800 border-2 border-green-500 rounded hover:bg-green-500 hover:bg-opacity-10 transition-all">
                                <div class="font-orbitron text-green-400 text-lg">F√ÅCIL</div>
                                <div class="text-gray-400 text-sm">Fondos iniciales: 600 SC</div>
                            </button>

                            <button onclick="completeSetupWithDifficulty('normal')"
                                class="p-4 bg-space-800 border-2 border-neon-blue rounded hover:bg-neon-blue hover:bg-opacity-10 transition-all">
                                <div class="font-orbitron text-neon-blue text-lg">NORMAL</div>
                                <div class="text-gray-400 text-sm">Fondos iniciales: 500 SC</div>
                            </button>

                            <button onclick="completeSetupWithDifficulty('hard')"
                                class="p-4 bg-space-800 border-2 border-neon-red rounded hover:bg-neon-red hover:bg-opacity-10 transition-all">
                                <div class="font-orbitron text-neon-red text-lg">DIF√çCIL</div>
                                <div class="text-gray-400 text-sm">Fondos iniciales: 400 SC</div>
                            </button>
                        </div>

                        <div id="setup-progress" class="hidden mt-4 text-center">
                            <div class="text-neon-blue">‚è≥ Creando personal inicial...</div>
                        </div>
                    </div>

                    <div id="planet-retry" class="hidden">
                        <p class="text-neon-red text-center text-xs mb-3">Este planeta no cumple los requisitos para ser
                            tu origen.</p>
                        <button onclick="nextPlanet()"
                            class="w-full py-3 bg-gray-700 border-2 border-gray-600 text-gray-300 rounded font-tech hover:bg-gray-600">
                            CONSULTAR SIGUIENTE C√ìDIGO (Reglas üìï)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Complete Setup Button -->
            <div id="complete-section" class="hidden text-center pt-4">
                <div class="bg-green-900 bg-opacity-20 border-2 border-neon-green rounded-lg p-6 mb-4">
                    <div class="text-neon-green text-xl font-orbitron mb-2">‚úì SETUP COMPLETADO</div>
                    <p class="text-gray-300 text-sm">Tu empresa est√° establecida y lista para operar</p>
                </div>
                <a href="/dashboard"
                    class="inline-block bg-neon-blue bg-opacity-20 hover:bg-opacity-30 border-2 border-neon-blue text-neon-blue px-8 py-4 rounded font-orbitron uppercase tracking-wider transition-all hover:shadow-[0_0_20px_rgba(0,243,255,0.5)] text-lg">
                    ‚ñ∂ ACCEDER AL PANEL DE CONTROL
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Get game_id from URL parameter or create new game
    let gameId = new URLSearchParams(window.location.search).get('game_id');
    let areaData = null;
    let densityData = null;

    // Cargar nombres iniciales al cargar la p√°gina
    window.addEventListener('DOMContentLoaded', async () => {
        await loadInitialNames();
    });

    async function loadInitialNames() {
        try {
            // Cargar nombre de compa√±√≠a
            const companyResp = await fetch('/api/suggestions/company-name');
            const companyData = await companyResp.json();
            document.getElementById('company-name').value = companyData.name;

            // Cargar nombre de nave
            const shipResp = await fetch('/api/suggestions/ship-name');
            const shipData = await shipResp.json();
            document.getElementById('ship-name').value = shipData.name;
        } catch (error) {
            console.error('Error cargando nombres iniciales:', error);
        }
    }

    async function suggestCompanyName() {
        try {
            const response = await fetch('/api/suggestions/company-name');
            const data = await response.json();
            document.getElementById('company-name').value = data.name;
        } catch (error) {
            console.error('Error sugiriendo nombre de compa√±√≠a:', error);
        }
    }

    async function suggestShipName() {
        try {
            const response = await fetch('/api/suggestions/ship-name');
            const data = await response.json();
            document.getElementById('ship-name').value = data.name;
        } catch (error) {
            console.error('Error sugiriendo nombre de nave:', error);
        }
    }

    async function saveCompanyDetails() {
        const companyName = document.getElementById('company-name').value;
        const shipName = document.getElementById('ship-name').value;
        const shipModel = document.getElementById('ship-model').value;

        if (!companyName || !shipName) {
            alert("Por favor introduce los nombres de tu compa√±√≠a y nave.");
            return;
        }

        try {
            // First create game if not exists
            if (!gameId) {
                const gameName = companyName.toLowerCase().replace(/\s+/g, '_');
                const createResp = await fetch('/api/games/new', {
                    method: 'POST',
                    body: new URLSearchParams({ game_name: gameName })
                });
                const gameData = await createResp.json();
                gameId = gameData.game_id;
                window.history.pushState({}, '', `?game_id=${gameId}`);
            }

            // Then save company details
            const formData = new FormData();
            formData.append('company_name', companyName);
            formData.append('ship_name', shipName);
            formData.append('ship_model', shipModel);

            await fetch(`/api/games/${gameId}/company-setup`, {
                method: 'POST',
                body: formData
            });

            // Transition UI
            document.getElementById('company-section').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('area-section').style.display = 'block';
            document.getElementById('btn-save-company').textContent = "Identidad Confirmada ‚úì";
            document.getElementById('btn-save-company').disabled = true;

        } catch (error) {
            alert('Error inicializando empresa: ' + error.message);
        }
    }

    // Manual input toggles
    function showManualArea() {
        document.getElementById('manual-area-input').classList.remove('hidden');
    }

    function showManualPosition() {
        document.getElementById('manual-position-input').classList.remove('hidden');
    }

    // Roll for area
    async function rollArea(isManual) {
        let formData = new FormData();

        if (isManual) {
            const die1 = document.getElementById('area-die1').value;
            const die2 = document.getElementById('area-die2').value;

            if (!die1 || !die2 || die1 < 1 || die1 > 6 || die2 < 1 || die2 > 6) {
                alert('Por favor introduce valores v√°lidos (1-6) para ambos dados');
                return;
            }

            formData.append('area_manual', `${die1},${die2}`);
        }

        try {
            const response = await fetch(`/api/games/${gameId}/setup`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            areaData = data.area;

            // Display results
            document.getElementById('area-dice').textContent = areaData.dice.join(' + ');
            document.getElementById('area-value').textContent = areaData.value;
            document.getElementById('area-result').classList.remove('hidden');

            // Show density section
            document.getElementById('density-section').style.display = 'block';

            // Hide manual input if shown
            document.getElementById('manual-area-input').classList.add('hidden');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Roll for density
    async function rollDensity(isManual) {
        let formData = new FormData();

        // Add area data (already rolled)
        if (areaData) {
            formData.append('area_manual', areaData.dice.join(','));
        }

        if (isManual) {
            const die1 = document.getElementById('density-die1').value;
            const die2 = document.getElementById('density-die2').value;

            if (!die1 || !die2 || die1 < 1 || die1 > 6 || die2 < 1 || die2 > 6) {
                alert('Por favor introduce valores v√°lidos (1-6) para ambos dados');
                return;
            }

            formData.append('density_manual', `${die1},${die2}`);
        }

        try {
            const response = await fetch(`/api/games/${gameId}/setup`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            densityData = data.world_density;

            // Display results
            document.getElementById('density-dice').textContent = densityData.dice.join(' + ');
            document.getElementById('density-total').textContent = densityData.total;
            document.getElementById('density-level').textContent = densityData.level;
            document.getElementById('density-result').classList.remove('hidden');

            // Show position section
            document.getElementById('position-section').style.display = 'block';

            // Hide manual input if shown
            document.getElementById('manual-density-input').classList.add('hidden');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Roll for position
    async function rollPosition(isManual) {
        let formData = new FormData();

        if (isManual) {
            const col = document.getElementById('pos-col-die').value;
            const row = document.getElementById('pos-row-die').value;

            if (!col || !row || col < 1 || col > 6 || row < 1 || row > 6) {
                alert('Por favor introduce valores v√°lidos (1-6) para ambos dados');
                return;
            }

            formData.append('col_manual', col);
            formData.append('row_manual', row);
        }

        try {
            const response = await fetch(`/api/games/${gameId}/setup-position`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            // Display results
            document.getElementById('pos-col-val').textContent = data.col_letter;
            document.getElementById('pos-row-val').textContent = data.row;
            document.getElementById('pos-quadrant').textContent = data.col_letter + data.row;
            document.getElementById('position-result').classList.remove('hidden');

            // Show planet section
            document.getElementById('planet-section').style.display = 'block';

            // Hide manual input if shown
            document.getElementById('manual-position-input').classList.add('hidden');
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Roll to find starting planet
    let currentPlanetCode = null;

    async function rollPlanet(isManual) {
        let code = "";
        if (isManual) {
            const d1 = document.getElementById('planet-die1').value;
            const d2 = document.getElementById('planet-die2').value;
            const d3 = document.getElementById('planet-die3').value;
            if (!d1 || !d2 || !d3 || d1 < 1 || d1 > 6 || d2 < 1 || d2 > 6 || d3 < 1 || d3 > 6) {
                alert("Por favor introduce valores v√°lidos (1-6) para los 3 dados");
                return;
            }
            code = "" + d1 + d2 + d3;
        } else {
            code = "" + (Math.floor(Math.random() * 6) + 1) + (Math.floor(Math.random() * 6) + 1) + (Math.floor(Math.random() * 6) + 1);
        }

        currentPlanetCode = parseInt(code);
        fetchPlanetData(currentPlanetCode);
    }

    async function nextPlanet() {
        if (!currentPlanetCode) return;

        try {
            const response = await fetch(`/api/planets/next/${currentPlanetCode}`);
            const data = await response.json();
            currentPlanetCode = data.planet.code;
            processPlanetData(data);
        } catch (error) {
            alert('Error buscando siguiente planeta: ' + error.message);
        }
    }

    function showManualPlanet() {
        document.getElementById('manual-planet-input').classList.remove('hidden');
    }

    async function fetchPlanetData(code) {
        try {
            const response = await fetch(`/api/planets/${code}`);
            const data = await response.json();
            processPlanetData(data);
        } catch (error) {
            alert('Error buscando planeta: ' + error.message);
        }
    }

    function processPlanetData(data) {
        const planet = data.planet;
        const validation = data.is_valid_start;

        document.getElementById('res-planet-name').textContent = planet.name;
        document.getElementById('res-planet-code').textContent = "#" + planet.code;
        document.getElementById('planet-result').classList.remove('hidden');
        document.getElementById('manual-planet-input').classList.add('hidden');

        // Handle validation check list
        const updateCheck = (id, status) => {
            const el = document.getElementById(id);
            el.innerHTML = status ? "‚úì" : "‚úó";
            el.className = status ? "text-neon-green" : "text-neon-red";
        };

        updateCheck('check-pop', validation.checks.population);
        updateCheck('check-tech', validation.checks.tech_level);
        updateCheck('check-support', validation.checks.life_support);
        updateCheck('check-conv', validation.checks.convenio);
        updateCheck('check-prod', validation.checks.has_product);

        // Clear data leak
        document.getElementById('input-tech').value = planet.bootstrap_data.tech_level || "";
        document.getElementById('input-pop').checked = planet.bootstrap_data.population_over_1000 === true;

        // Handle badge and actions
        const badge = document.getElementById('val-badge');
        if (planet.bootstrap_data.tech_level === null || planet.bootstrap_data.population_over_1000 === null) {
            badge.textContent = "DATOS PENDIENTES";
            badge.className = "px-3 py-1 rounded text-xs font-tech uppercase bg-orange-500 bg-opacity-20 text-orange-400";
            document.getElementById('missing-data-form').classList.remove('hidden');
            document.getElementById('planet-action').classList.add('hidden');
            document.getElementById('planet-retry').classList.add('hidden');
        } else if (validation.is_valid) {
            badge.textContent = "PLANETA APTO";
            badge.className = "px-3 py-1 rounded text-xs font-tech uppercase bg-neon-green bg-opacity-20 text-neon-green";
            document.getElementById('missing-data-form').classList.add('hidden');
            document.getElementById('planet-action').classList.remove('hidden');
            document.getElementById('planet-retry').classList.add('hidden');
        } else {
            badge.textContent = "NO APTO";
            badge.className = "px-3 py-1 rounded text-xs font-tech uppercase bg-neon-red bg-opacity-20 text-neon-red";
            document.getElementById('missing-data-form').classList.add('hidden');
            document.getElementById('planet-action').classList.add('hidden');
            document.getElementById('planet-retry').classList.remove('hidden');
        }
    }

    async function updatePlanetData() {
        const tech = document.getElementById('input-tech').value;
        const pop = document.getElementById('input-pop').checked;
        if (!tech) return alert("Selecciona el nivel tecnol√≥gico");

        const formData = new FormData();
        formData.append('tech_level', tech);
        formData.append('population_over_1000', pop ? "true" : "false");

        try {
            await fetch(`/api/planets/${currentPlanetCode}/update-bootstrap`, {
                method: 'POST',
                body: formData
            });
            // Re-fetch to update UI
            fetchPlanetData(currentPlanetCode);
        } catch (error) {
            alert('Error actualizando datos: ' + error.message);
        }
    }

    async function selectStartingPlanet() {
        const formData = new FormData();
        formData.append('code', currentPlanetCode);

        try {
            await fetch(`/api/games/${gameId}/set-starting-planet`, {
                method: 'POST',
                body: formData
            });

            // Hide planet selection and show difficulty selection
            document.getElementById('planet-action').classList.add('hidden');
            document.getElementById('difficulty-section').classList.remove('hidden');

        } catch (error) {
            alert('Error estableciendo planeta: ' + error.message);
        }
    }

    async function completeSetupWithDifficulty(difficulty) {
        document.getElementById('setup-progress').classList.remove('hidden');

        try {
            const formData = new FormData();
            formData.append('difficulty', difficulty);

            const response = await fetch(`/api/games/${gameId}/complete-setup`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.status === 'success') {
                // Show success message
                document.getElementById('setup-progress').innerHTML = `
                    <div class="text-neon-green">‚úÖ Setup completado!</div>
                    <div class="text-gray-400 text-sm mt-2">
                        Personal inicial: ${data.personnel_count} empleados<br>
                        Salarios mensuales: ${data.monthly_salaries} SC<br>
                        Fondos iniciales: ${data.starting_funds} SC
                    </div>
                `;

                // Wait a moment then show dashboard button
                setTimeout(() => {
                    document.getElementById('complete-section').classList.remove('hidden');
                    document.querySelector('#complete-section a').href = `/dashboard?game_id=${gameId}`;
                }, 1500);
            }
        } catch (error) {
            alert('Error completando setup: ' + error.message);
            document.getElementById('setup-progress').classList.add('hidden');
        }
    }
</script>
{% endblock %}