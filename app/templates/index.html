{% extends "base.html" %}
<!--
    P√°gina de inicio (landing page) de Spacegom Companion.
    
    Muestra estad√≠sticas de partidas guardadas, lista de juegos disponibles,
    y opciones para iniciar nueva partida o continuar la √∫ltima.
    
    Funcionalidad JavaScript:
    - loadGames(): Carga lista de partidas desde API
    - continueLastGame(): Carga la partida m√°s reciente
    - C√°lculo de estad√≠sticas (total, activas, √∫ltima actividad, √°reas exploradas)
-->

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Secci√≥n Command Center: Bienvenida y opciones de navegaci√≥n -->
    <div class="md:col-span-2">
        <div class="glass-panel tech-border p-6 rounded-lg mb-8">
            <h2 class="text-2xl font-orbitron text-white mb-4 border-b border-gray-700 pb-2">
                <span class="text-neon-blue">COMMAND</span> CENTER
            </h2>
            <p class="mb-6 text-gray-300">Bienvenido, Comandante. Sistema operativo. Esperando √≥rdenes.</p>

            <!-- Opciones de navegaci√≥n: Nueva Partida y Continuar √öltima -->
            <div class="mb-6 flex gap-4">
                <a href="/setup"
                    class="flex-1 bg-neon-green bg-opacity-20 hover:bg-opacity-30 border-2 border-neon-green text-neon-green px-6 py-3 rounded font-orbitron uppercase tracking-wider transition-all hover:shadow-[0_0_20px_rgba(0,255,157,0.5)] text-center">
                    üé≤ NUEVA PARTIDA
                </a>
                <button id="continue-btn" onclick="continueLastGame()" disabled
                    class="flex-1 bg-neon-blue bg-opacity-20 hover:bg-opacity-30 border-2 border-neon-blue text-neon-blue px-6 py-3 rounded font-orbitron uppercase tracking-wider transition-all hover:shadow-[0_0_20px_rgba(0,243,255,0.5)] text-center disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚ñ∂ CONTINUAR √öLTIMA
                </button>
            </div>

            <!-- Estad√≠sticas resumen: Total partidas, Activas, √öltima actividad, √Åreas exploradas -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-space-800 p-3 rounded border border-gray-700">
                    <div class="text-xs text-gray-500 uppercase">Total Partidas</div>
                    <div class="text-neon-green font-orbitron text-xl" id="total-games">0</div>
                </div>
                <div class="bg-space-800 p-3 rounded border border-gray-700">
                    <div class="text-xs text-gray-500 uppercase">Partidas Activas</div>
                    <div class="text-neon-blue font-orbitron text-xl" id="active-games">0</div>
                </div>
                <div class="bg-space-800 p-3 rounded border border-gray-700">
                    <div class="text-xs text-gray-500 uppercase">√öltima Actividad</div>
                    <div class="text-white font-tech text-sm" id="last-activity">---</div>
                </div>
                <div class="bg-space-800 p-3 rounded border border-gray-700">
                    <div class="text-xs text-gray-500 uppercase">√Åreas Exploradas</div>
                    <div class="text-neon-blue font-orbitron text-xl" id="areas-explored">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de partidas guardadas - Se carga din√°micamente desde API -->
    <div class="md:col-span-1">
        <div class="glass-panel tech-border p-6 rounded-lg h-full">
            <h3 class="font-orbitron text-neon-blue mb-4 text-sm tracking-wider flex items-center gap-2">
                <span>üìÅ</span> PARTIDAS GUARDADAS
            </h3>
            <div id="games-list" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                <div class="text-gray-500 italic text-sm">Cargando partidas...</div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n del sistema: Versi√≥n, BD, √°reas disponibles, estado -->
    <div class="md:col-span-1">
        <div class="glass-panel tech-border p-6 rounded-lg h-full">
            <h3 class="font-orbitron text-neon-blue mb-4 text-sm tracking-wider flex items-center gap-2">
                <span>‚ÑπÔ∏è</span> INFORMACI√ìN DEL SISTEMA
            </h3>
            <div class="space-y-3 text-sm text-gray-300">
                <div class="flex justify-between border-b border-gray-700 pb-2">
                    <span class="text-gray-400">Versi√≥n:</span>
                    <span class="text-neon-green font-tech">Spacegom v1.0</span>
                </div>
                <div class="flex justify-between border-b border-gray-700 pb-2">
                    <span class="text-gray-400">Base de Datos:</span>
                    <span class="text-white font-tech">216 planetas</span>
                </div>
                <div class="flex justify-between border-b border-gray-700 pb-2">
                    <span class="text-gray-400">√Åreas Disponibles:</span>
                    <span class="text-neon-blue font-tech">2 - 12</span>
                </div>
                <div class="flex justify-between border-b border-gray-700 pb-2">
                    <span class="text-gray-400">Estado del Sistema:</span>
                    <span class="text-neon-green font-tech">‚óè OPERATIVO</span>
                </div>
                <div class="mt-4 p-3 bg-space-800 rounded border border-gray-700">
                    <div class="text-xs text-gray-500 uppercase mb-2">√öltima Actualizaci√≥n</div>
                    <div class="text-[10px] text-gray-400 font-mono">
                        2026-01-18 | Dashboard redise√±ado<br>
                        Gesti√≥n de √°reas y planetas mejorada
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * Carga todas las partidas desde la API y actualiza la UI.
     * Calcula estad√≠sticas y popula la lista de partidas guardadas.
     */
    async function loadGames() {
        try {
            const response = await fetch('/api/games');
            const data = await response.json();

            const gamesList = document.getElementById('games-list');
            const continueBtn = document.getElementById('continue-btn');

            // Update stats
            document.getElementById('total-games').textContent = data.games.length;
            document.getElementById('active-games').textContent = data.games.length;

            // Get unique areas
            const areas = new Set(data.games.map(g => g.area).filter(a => a));
            document.getElementById('areas-explored').textContent = areas.size;

            // Find most recent
            if (data.games.length > 0) {
                const sorted = data.games.sort((a, b) =>
                    new Date(b.updated_at) - new Date(a.updated_at)
                );

                const latest = new Date(sorted[0].updated_at);
                const now = new Date();
                const diff = Math.floor((now - latest) / 1000 / 60); // minutes

                if (diff < 60) {
                    document.getElementById('last-activity').textContent = `Hace ${diff}m`;
                } else if (diff < 1440) {
                    document.getElementById('last-activity').textContent = `Hace ${Math.floor(diff / 60)}h`;
                } else {
                    document.getElementById('last-activity').textContent = `Hace ${Math.floor(diff / 1440)}d`;
                }

                // Populate games list
                gamesList.innerHTML = '';
                sorted.forEach(game => {
                    const card = createGameCard(game);
                    gamesList.appendChild(card);
                });

                // Enable continue button
                continueBtn.disabled = false;
            } else {
                gamesList.innerHTML = '<div class="text-gray-500 italic text-sm py-4 text-center">No hay partidas guardadas.<br>¬°Comienza una nueva aventura!</div>';
                continueBtn.disabled = true;
            }

        } catch (error) {
            console.error('Error loading games:', error);
            document.getElementById('games-list').innerHTML =
                '<div class="text-neon-red text-sm">Error al cargar partidas</div>';
        }
    }

    function createGameCard(game) {
        const card = document.createElement('div');
        card.className = 'bg-space-800 border border-gray-700 hover:border-neon-blue rounded p-3 cursor-pointer transition-all';
        card.onclick = () => window.location.href = `/dashboard?game_id=${game.game_id}`;

        const date = new Date(game.updated_at);
        const dateStr = date.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        card.innerHTML = `
            <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                    <div class="text-neon-blue font-orbitron text-sm">${game.company_name || game.game_id}</div>
                    <div class="text-[10px] text-gray-500 font-tech">${game.ship_name || 'Sin nombre'}</div>
                </div>
                <div class="text-xs text-gray-400 font-mono">${dateStr}</div>
            </div>
            <div class="flex gap-2 text-[10px]">
                ${game.area ? `<span class="px-2 py-0.5 bg-neon-blue bg-opacity-20 border border-neon-blue text-neon-blue rounded">√Årea ${game.area}</span>` : ''}
                ${game.world_density ? `<span class="px-2 py-0.5 bg-gray-700 border border-gray-600 text-gray-300 rounded">${game.world_density}</span>` : ''}
                ${game.ship_model ? `<span class="px-2 py-0.5 bg-gray-700 border border-gray-600 text-gray-300 rounded">${game.ship_model}</span>` : ''}
            </div>
        `;

        return card;
    }

    function continueLastGame() {
        fetch('/api/games')
            .then(r => r.json())
            .then(data => {
                if (data.games.length > 0) {
                    const latest = data.games.sort((a, b) =>
                        new Date(b.updated_at) - new Date(a.updated_at)
                    )[0];
                    window.location.href = `/dashboard?game_id=${latest.game_id}`;
                }
            });
    }

    window.onload = loadGames;
</script>
{% endblock %}