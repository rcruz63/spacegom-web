# Sistema Unificado de Dados - Estado Actual y Recomendaciones

## üìä Estado Actual del Sistema de Dados

Despu√©s de revisar todo el c√≥digo del proyecto, el sistema de dados **NO es coherente** y tiene m√∫ltiples implementaciones paralelas. A continuaci√≥n, el an√°lisis completo:

---

## üîç Implementaciones Existentes

### 1. **DiceRoller (Python Backend)**
**Ubicaci√≥n**: [`app/dice.py`](docs/dice.md)

**Caracter√≠sticas**:
- ‚úÖ Clase `DiceRoller` con m√©todos est√°ticos
- ‚úÖ Generaci√≥n autom√°tica de dados
- ‚úÖ Soporte para dados manuales
- ‚úÖ Utilidades para c√≥digos planetarios (3d6)
- ‚úÖ Conversi√≥n de densidad de mundos (2d6)
- ‚úÖ Historial de tiradas (`DiceHistoryEntry`)

**Uso**: Principalmente en setup inicial y algunos endpoints

### 2. **DiceRollerUI (JavaScript Frontend)**
**Ubicaci√≥n**: [`app/static/js/dice-roller.js`](docs/dice-roller.md)

**Caracter√≠sticas**:
- ‚úÖ Interfaz unificada para todas las tiradas
- ‚úÖ Modal de selecci√≥n: Autom√°tico vs Manual
- ‚úÖ Visualizaci√≥n individual de dados
- ‚úÖ Soporte para modificadores
- ‚úÖ Callback as√≠ncrono
- ‚úÖ Llamada al backend `/api/dice/roll`

**Uso**: Personal, transporte de pasajeros, algunas acciones futuras

### 3. **Setup Manual (JavaScript Directo)**
**Ubicaci√≥n**: [`app/templates/setup.html`](docs/setup.html.md)

**Caracter√≠sticas**:
- ‚ùå No usa DiceRollerUI
- ‚ùå L√≥gica de dados embebida en el template
- ‚ùå Solo modo autom√°tico (sin opci√≥n manual)
- ‚ùå No visualizaci√≥n de dados individuales

**Problema**: Inconsistente con el resto del sistema

### 4. **Endpoint Universal**
**Ubicaci√≥n**: [`app/main.py`](docs/main.md) - `/api/dice/roll`

**Caracter√≠sticas**:
- ‚úÖ Endpoint universal para tiradas
- ‚úÖ Soporte para dados manuales y autom√°ticos
- ‚úÖ Validaci√≥n de entrada
- ‚úÖ Compatible con DiceRollerUI  

## Uso B√°sico

### Sintaxis

```javascript
await DiceRollerUI.requestRoll({
    numDice: 2,              // N√∫mero de dados a tirar
    diceSides: 6,            // Caras del dado (default: 6)
    title: "T√≠tulo",         // T√≠tulo del modal
    description: "...",      // Descripci√≥n opcional
    modifiers: {             // Modificadores opcionales
        "Nombre": valor
    },
    onResult: async (result) => {
        // Callback cuando se obtiene resultado
        // result.dice: array de valores individuales
        // result.sum: suma de dados
        // result.total: suma + modificadores
        // result.mode: 'auto' o 'manual'
    }
});
```

### Objeto `result`

```javascript
{
    dice: [3, 5],           // Valores individuales de cada dado
    sum: 8,                 // Suma de los dados
    mode: 'auto',           // 'auto' o 'manual'
    modifiers: {            // Modificadores aplicados
        "Experiencia": 1,
        "Moral": -1
    },
    total: 8                // sum + suma de modificadores
}
```

## Ejemplos de Uso

### Ejemplo 1: B√∫squeda de Personal

**Contexto**: Calcular d√≠as de b√∫squeda para contratar personal.

**Implementaci√≥n**: [`personnel.html`](file:///home/rcruz63/desarrollo/spacegom-web/app/templates/personnel.html#L393-L448) (l√≠neas 393-448)

```javascript
async function startHireSearch() {
    const experienceModifiers = {
        'Novato': -1,
        'Est√°ndar': 0,
        'Veterano': 1
    };

    await DiceRollerUI.requestRoll({
        numDice: 2,
        diceSides: 6,
        title: "B√∫squeda de Personal",
        description: `Calculando d√≠as para encontrar ${selectedPosition.name}`,
        modifiers: {
            [selectedLevel]: experienceModifiers[selectedLevel]
        },
        onResult: async (diceResult) => {
            // Enviar resultado al backend
            const formData = new FormData();
            formData.append('position', selectedPosition.name);
            formData.append('experience_level', selectedLevel);
            formData.append('manual_dice_days', diceResult.dice.join(','));
            
            const response = await fetch(`/api/games/${gameId}/hire/start`, {
                method: 'POST',
                body: formData
            });
            
            // Procesar respuesta...
        }
    });
}
```

### Ejemplo 2: Tirada Simple sin Modificadores

```javascript
async function rollForRandomEvent() {
    await DiceRollerUI.requestRoll({
        numDice: 1,
        diceSides: 6,
        title: "Evento Aleatorio",
        description: "¬øQu√© sucede hoy?",
        onResult: async (result) => {
            if (result.sum >= 4) {
                showToast('¬°Evento positivo!', 'success');
            } else {
                showToast('Evento negativo', 'warning');
            }
        }
    });
}
```

### Ejemplo 3: Tirada con M√∫ltiples Modificadores

```javascript
async function combatRoll() {
    await DiceRollerUI.requestRoll({
        numDice: 3,
        diceSides: 6,
        title: "Combate Espacial",
        description: "Resolviendo ataque",
        modifiers: {
            "Habilidad Piloto": 2,
            "Da√±o en Nave": -1,
            "Bonificaci√≥n T√°ctica": 1
        },
        onResult: async (result) => {
            console.log(`Dados: ${result.dice.join(', ')}`);
            console.log(`Suma: ${result.sum}`);
            console.log(`Total con modificadores: ${result.total}`);
            
            // Enviar al backend para resolver combate
            await resolveComat(result);
        }
    });
}
```

## Flujo de Usuario

```mermaid
graph TD
    A[Usuario hace clic en acci√≥n que requiere dados] --> B[Se muestra modal de selecci√≥n de modo]
    B --> C{Usuario elige modo}
    C -->|Autom√°tico| D[Sistema genera dados aleatorios]
    C -->|Manual| E[Usuario introduce valores de dados f√≠sicos]
    D --> F[Se muestra modal con resultado]
    E --> F
    F --> G[Se ejecuta callback onResult]
    G --> H[Aplicaci√≥n procesa resultado]
```

## Integraci√≥n con Backend

### Env√≠o de Dados al Backend

Cuando env√≠es dados al backend, usa el formato de valores separados por comas:

```javascript
formData.append('manual_dice', diceResult.dice.join(','));
// Ejemplo: "3,5" para dados [3, 5]
```

### Recepci√≥n en FastAPI

```python
@app.post("/api/some-endpoint")
async def some_endpoint(
    manual_dice: Optional[str] = Form(None)
):
    if manual_dice:
        # Parsear dados manuales
        dice_values = [int(x) for x in manual_dice.split(',')]
    else:
        # Generar dados autom√°ticos
        dice_roller = DiceRoller()
        dice_values = dice_roller.roll_dice(2, 6)
    
    dice_sum = sum(dice_values)
    # Procesar tirada...
```

## API Backend de Dados

### Endpoint: `POST /api/dice/roll`

El sistema puede usar el endpoint del backend para tiradas autom√°ticas:

```javascript
// Llamada autom√°tica desde DiceRollerUI.rollAutomatic()
const response = await fetch('/api/dice/roll', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        num_dice: 2,
        dice_sides: 6
    })
});

const data = await response.json();
// data.dice: [4, 2]
```

## Mejores Pr√°cticas

### ‚úÖ DO (Hacer)

1. **Siempre usar DiceRollerUI** para tiradas de dados (consistencia)
2. **Proporcionar t√≠tulos descriptivos** que indiquen el prop√≥sito
3. **Usar modificadores con nombres claros** (ej: "Experiencia", no "exp")
4. **Manejar errores** en el callback `onResult`
5. **Enviar dados al backend** en el formato esperado (string separado por comas)

### ‚ùå DON'T (Evitar)

1. **No generar dados manualmente** con `Math.random()` - usar DiceRollerUI
2. **No saltarse la opci√≥n manual** - siempre ofr√©cela al jugador
3. **No ocultar valores individuales** - mostrar cada dado
4. **No modificar directamente** el c√≥digo de dice-roller.js
5. **No asumir que el usuario siempre elegir√° autom√°tico** - soportar ambos modos

## Personalizaci√≥n Visual

Los modales usan las clases CSS globales definidas en `base.html`:

- `glass-panel` - Fondo con efecto cristal
- `tech-border` - Bordes tecnol√≥gicos con esquinas
- `neon-blue`, `neon-green` - Colores ne√≥n del tema
- `font-orbitron` - Fuente principal
- `bg-space-800` - Fondos oscuros

Para personalizar, modifica estas clases en `base.html` o agrega estilos espec√≠ficos.

## Troubleshooting

### Problema: "DiceRollerUI is not defined"

**Causa**: Los archivos est√°ticos no se est√°n sirviendo correctamente.

**Soluci√≥n**: 
1. Verificar que [`main.py`](file:///home/rcruz63/desarrollo/spacegom-web/app/main.py#L22) tiene la configuraci√≥n de StaticFiles:
   ```python
   app.mount("/static", StaticFiles(directory="app/static"), name="static")
   ```
2. Verificar que [`base.html`](file:///home/rcruz63/desarrollo/spacegom-web/app/templates/base.html#L211) carga el script:
   ```html
   <script src="/static/js/dice-roller.js"></script>
   ```

### Problema: El callback no se ejecuta

**Causa**: Posible error en el callback que detiene la ejecuci√≥n.

**Soluci√≥n**: Envolver el callback en try-catch:

```javascript
onResult: async (result) => {
    try {
        // Tu c√≥digo aqu√≠
    } catch (error) {
        console.error('Error en callback:', error);
        showToast('Error procesando resultado', 'error');
    }
}
```

## Extensiones Futuras

Posibles mejoras para considerar:

- **Animaciones de dados**: Efecto visual de dados girando
- **Sonidos**: Efectos de audio al tirar dados
- **Historial de tiradas**: Guardar √∫ltimas N tiradas
- **Dados especiales**: Soporte para dados de otros tipos (d10, d20, etc.)
- **Dados m√∫ltiples diferentes**: Tirar 1d6 + 1d10 simult√°neamente

## Mantenimiento

- **Versi√≥n actual**: 1.0
- **√öltima actualizaci√≥n**: 2026-01-11
- **Autor**: Sistema Spacegom
- **Responsable**: Equipo de desarrollo

---

**Resumen**: DiceRollerUI proporciona una experiencia de juego consistente y flexible para todas las tiradas de dados. √ösalo siempre que necesites generar n√∫meros aleatorios en el contexto del juego.
